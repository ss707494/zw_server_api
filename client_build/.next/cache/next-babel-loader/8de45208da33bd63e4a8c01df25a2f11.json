{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/esm/asyncToGenerator\";\nvar __jsx = React.createElement;\nimport React, { useEffect } from 'react';\nimport { doc } from '../../graphqlTypes/doc';\nimport { dealMaybeNumber, dealMoney, fpMerge } from '../../tools/utils';\nimport { useStoreModel } from '../../ModelAction/useStore';\nimport { ls } from '../../tools/dealKey';\nimport { HeaderTitle } from '../../components/HeaderTitle/HeaderTitle';\nimport { Box, Button, LinearProgress, MenuItem, TextField } from '@material-ui/core';\nimport { grey } from '@material-ui/core/colors';\nimport styled from 'styled-components';\nimport { DiscountConditionEnum, DiscountTypeEnum, getPickUpTypeName, PickUpTypeEnum } from '../../ss_common/enum';\nimport { CartProduct } from './CartProduct';\nimport { BScroller } from '../../components/BScroll/BScroller';\nimport { pageTypeEnum, shopCartModel } from './index';\nimport { dealNoAuth } from '../../components/NoAuth/NoAuth';\nimport { Space } from '../../components/Box/Box';\nimport { InputPromoCodeDialog, inputPromoCodeModel } from './components/InputPromoCode';\nimport CloseIcon from '@material-ui/icons/Close';\nvar BoxContain = styled.section.withConfig({\n  displayName: \"shopCart__BoxContain\",\n  componentId: \"sc-2w144c-0\"\n})([\"padding:0 20px;\"]);\nvar Title = styled.div.withConfig({\n  displayName: \"shopCart__Title\",\n  componentId: \"sc-2w144c-1\"\n})([\"font-size:18px;font-weight:bold;margin:16px 0 12px;\"]);\nvar PromoCode = styled.div.withConfig({\n  displayName: \"shopCart__PromoCode\",\n  componentId: \"sc-2w144c-2\"\n})([\"display:flex;> aside{margin-left:8px;}\"]);\nvar Money = styled.div.withConfig({\n  displayName: \"shopCart__Money\",\n  componentId: \"sc-2w144c-3\"\n})([\"display:flex;justify-content:space-between;\"]);\nvar FixFooter = styled(Box).withConfig({\n  displayName: \"shopCart__FixFooter\",\n  componentId: \"sc-2w144c-4\"\n})([\"padding:20px;position:fixed;bottom:0;width:100vw;box-sizing:border-box;background:#fff;\"]);\nexport var ShopCartPage = function ShopCartPage() {\n  var _useStoreModel = useStoreModel(shopCartModel),\n      stateSCM = _useStoreModel.state,\n      actionsSCM = _useStoreModel.actions,\n      getLoad = _useStoreModel.getLoad;\n\n  var _useStoreModel2 = useStoreModel(inputPromoCodeModel),\n      actionsInputPromoCodeModel = _useStoreModel2.actions;\n\n  useEffect(function () {\n    if (stateSCM.shopCartList.length === 0) {\n      actionsSCM.getList();\n    }\n  }, []);\n  useEffect(function () {\n    if (stateSCM.user.id && localStorage.getItem(\"promoCode_\".concat(stateSCM.user.id))) {\n      actionsSCM.dealPromoCode(\"\".concat(localStorage.getItem(\"promoCode_\".concat(stateSCM.user.id))));\n    }\n  }, [stateSCM.user.id]);\n  var productNumber = stateSCM.dealProductNumber(stateSCM);\n  var productSubtotal = dealMoney(stateSCM.dealProductTotal(stateSCM));\n  var promoCode = stateSCM.promoCode;\n  var discountProduct = stateSCM.shopCartList.filter(function (v) {\n    var _v$product, _v$product$category, _v$product2, _v$product2$category, _v$product2$category$, _v$product3, _v$product3$category, _v$product3$category$, _v$product3$category$2;\n\n    return [(_v$product = v.product) === null || _v$product === void 0 ? void 0 : (_v$product$category = _v$product.category) === null || _v$product$category === void 0 ? void 0 : _v$product$category.id, (_v$product2 = v.product) === null || _v$product2 === void 0 ? void 0 : (_v$product2$category = _v$product2.category) === null || _v$product2$category === void 0 ? void 0 : (_v$product2$category$ = _v$product2$category.parentCategory) === null || _v$product2$category$ === void 0 ? void 0 : _v$product2$category$.id, (_v$product3 = v.product) === null || _v$product3 === void 0 ? void 0 : (_v$product3$category = _v$product3.category) === null || _v$product3$category === void 0 ? void 0 : (_v$product3$category$ = _v$product3$category.parentCategory) === null || _v$product3$category$ === void 0 ? void 0 : (_v$product3$category$2 = _v$product3$category$.parentCategory) === null || _v$product3$category$2 === void 0 ? void 0 : _v$product3$category$2.id].includes(promoCode.productCategory);\n  });\n  var discountProductAmount = discountProduct.reduce(function (previousValue, currentValue) {\n    var _currentValue$product;\n\n    return previousValue + dealMaybeNumber(currentValue.number) * dealMaybeNumber((_currentValue$product = currentValue.product) === null || _currentValue$product === void 0 ? void 0 : _currentValue$product.priceOut);\n  }, 0); // 计算折扣\n\n  var discountAmountForPromoCode = 0;\n\n  if (discountProduct.length) {\n    // 折扣条件\n    if (promoCode.discountCondition === DiscountConditionEnum.No || promoCode.discountCondition === DiscountConditionEnum.Amount && discountProductAmount > dealMaybeNumber(promoCode.discountConditionAmount)) {\n      discountAmountForPromoCode = promoCode.discountType === DiscountTypeEnum.Amount ? dealMaybeNumber(promoCode.discountAmount) : dealMaybeNumber(promoCode.discountAmount) * discountProductAmount / 100;\n    }\n  }\n\n  useEffect(function () {\n    if (discountAmountForPromoCode) {\n      actionsSCM.setForm(['couponDiscount', discountAmountForPromoCode]);\n    }\n  }, [discountAmountForPromoCode]);\n  var allTotal = stateSCM.dealProductTotal(stateSCM) - dealMaybeNumber(stateSCM.form.couponDiscount);\n  return __jsx(\"div\", null, __jsx(HeaderTitle, {\n    title: '购物车',\n    LeftIcon: CloseIcon\n  }), dealNoAuth(__jsx(React.Fragment, null, !!getLoad(doc.userShopCartList) && __jsx(LinearProgress, null) || __jsx(\"div\", {\n    style: {\n      height: '4px'\n    }\n  }), __jsx(BScroller, {\n    boxHeight: 'calc(100vh - 65px)'\n  }, __jsx(BoxContain, null, __jsx(\"div\", {\n    style: {\n      paddingTop: '16px',\n      fontSize: '18px',\n      textAlign: 'center'\n    }\n  }, productNumber, ls('件商品')), __jsx(\"div\", {\n    style: {\n      fontSize: '14px',\n      textAlign: 'center',\n      color: grey[600],\n      marginTop: '8px',\n      marginBottom: '10px'\n    }\n  }, ls('小计'), \":\", productSubtotal), stateSCM.shopCartList.map(function (value) {\n    return __jsx(CartProduct, {\n      key: \"CartProduct_\".concat(value.id),\n      shopCart: value\n    });\n  }), __jsx(TextField, {\n    style: {\n      marginTop: '10px'\n    },\n    fullWidth: true,\n    label: ls('运送方式'),\n    select: true,\n    value: stateSCM.form.pickUpType,\n    onChange: function onChange(event) {\n      actionsSCM.setForm(['pickUpType', event.target.value]);\n      actionsSCM.setForm(['addressId', stateSCM.initAddressId(fpMerge(stateSCM, {\n        form: {\n          pickUpType: event.target.value\n        }\n      }))]);\n    }\n  }, __jsx(MenuItem, {\n    value: PickUpTypeEnum.Self\n  }, ls(getPickUpTypeName(PickUpTypeEnum.Self))), __jsx(MenuItem, {\n    value: PickUpTypeEnum.Delivery\n  }, ls(getPickUpTypeName(PickUpTypeEnum.Delivery)))), __jsx(Title, null, ls('达人卡和优惠券')), __jsx(PromoCode, null, __jsx(\"main\", null, stateSCM.promoCode.title), __jsx(\"aside\", null, ls('code'), \": \", stateSCM.promoCode.code)), __jsx(Space, {\n    h: 8\n  }), __jsx(Button, {\n    variant: 'outlined',\n    onClick: /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n      return _regeneratorRuntime.wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              _context.next = 2;\n              return actionsInputPromoCodeModel.openClick(function (promoCode) {\n                return actionsSCM.dealPromoCode(promoCode);\n              });\n\n            case 2:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee);\n    }))\n  }, ls(stateSCM.promoCode.code ? '重新输入' : '输入验证码')), __jsx(InputPromoCodeDialog, null), __jsx(Title, null, ls('预估价格')), __jsx(Money, null, __jsx(\"aside\", null, ls('小计')), __jsx(\"main\", null, productSubtotal)), __jsx(Space, {\n    h: 10\n  }), __jsx(Money, null, __jsx(\"aside\", null, ls('折扣')), __jsx(\"main\", null, dealMoney(stateSCM.form.couponDiscount))), __jsx(\"div\", {\n    style: {\n      width: '100%',\n      height: '10px'\n    }\n  }), __jsx(Money, null, __jsx(\"aside\", null, ls('总计')), __jsx(\"main\", null, dealMoney(allTotal))), __jsx(Title, null, ls('下次购买的商品')), stateSCM.shopCartListNext.map(function (value) {\n    return __jsx(CartProduct, {\n      key: \"CartProduct_\".concat(value.id),\n      shopCart: value\n    });\n  }), __jsx(\"div\", {\n    style: {\n      width: '100%',\n      height: '100px'\n    }\n  }))), __jsx(FixFooter, {\n    boxShadow: 1\n  }, __jsx(Button, {\n    variant: 'contained',\n    color: 'secondary',\n    fullWidth: true,\n    disabled: productNumber === 0,\n    onClick: function onClick() {\n      return actionsSCM.updatePageType(pageTypeEnum.order);\n    }\n  }, \"\\u53BB\\u7ED3\\u7B97\")))));\n};","map":null,"metadata":{},"sourceType":"module"}