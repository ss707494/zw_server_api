{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/esm/asyncToGenerator\";\n\nvar _this = this,\n    _jsxFileName = \"D:\\\\code\\\\zw\\\\zw_client_web\\\\utils\\\\view\\\\m\\\\cart\\\\shopCart.tsx\",\n    _s = $RefreshSig$();\n\nvar __jsx = React.createElement;\nimport React, { useEffect } from 'react';\nimport { doc } from '../../../graphqlTypes/doc';\nimport { dealMaybeNumber, dealMoney, fpMerge } from '../../../tools/utils';\nimport { useStoreModel } from '../../../ModelAction/useStore';\nimport { ll } from '../../../tools/dealKey';\nimport { HeaderTitle } from '../../../components/HeaderTitle/HeaderTitle';\nimport { Box, Button, LinearProgress, MenuItem, TextField } from '@material-ui/core';\nimport { grey } from '@material-ui/core/colors';\nimport styled from 'styled-components';\nimport { DiscountConditionEnum, DiscountTypeEnum, getPickUpTypeName, PickUpTypeEnum } from '../../../ss_common/enum';\nimport { CartProduct } from './CartProduct';\nimport { BScroller } from '../../../components/BScroll/BScroller';\nimport { pageTypeEnum, shopCartModel } from './index';\nimport { DealNoAuth } from '../../../components/NoAuth/NoAuth';\nimport { Space } from '../../../components/Box/Box';\nimport { InputPromoCodeDialog, inputPromoCodeModel } from './components/InputPromoCode';\nimport CloseIcon from '@material-ui/icons/Close';\nimport { UpdateShopCart } from '../../../components/ProductItem/UpdateShopCart';\nvar BoxContain = styled.section.withConfig({\n  displayName: \"shopCart__BoxContain\",\n  componentId: \"z4gqjv-0\"\n})([\"padding:0 20px;\"]);\n_c = BoxContain;\nvar Title = styled.div.withConfig({\n  displayName: \"shopCart__Title\",\n  componentId: \"z4gqjv-1\"\n})([\"font-size:18px;font-weight:bold;margin:16px 0 12px;\"]);\n_c2 = Title;\nvar PromoCode = styled.div.withConfig({\n  displayName: \"shopCart__PromoCode\",\n  componentId: \"z4gqjv-2\"\n})([\"display:flex;> aside{margin-left:8px;}\"]);\n_c3 = PromoCode;\nvar Money = styled.div.withConfig({\n  displayName: \"shopCart__Money\",\n  componentId: \"z4gqjv-3\"\n})([\"display:flex;justify-content:space-between;\"]);\n_c4 = Money;\nvar FixFooter = styled(Box).withConfig({\n  displayName: \"shopCart__FixFooter\",\n  componentId: \"z4gqjv-4\"\n})([\"padding:20px;position:fixed;bottom:0;width:100vw;box-sizing:border-box;background:#fff;\"]);\n_c5 = FixFooter;\nexport var ShopCartPage = function ShopCartPage() {\n  _s();\n\n  var _useStoreModel = useStoreModel(shopCartModel),\n      stateShopCartModel = _useStoreModel.state,\n      actionsShopCartModel = _useStoreModel.actions,\n      getLoad = _useStoreModel.getLoad;\n\n  var _useStoreModel2 = useStoreModel(inputPromoCodeModel),\n      actionsInputPromoCodeModel = _useStoreModel2.actions;\n\n  useEffect(function () {\n    if (stateShopCartModel.shopCartList.length === 0) {\n      actionsShopCartModel.getList();\n    }\n  }, [actionsShopCartModel, stateShopCartModel.shopCartList.length]);\n  useEffect(function () {\n    if (stateShopCartModel.user.id && localStorage.getItem(\"promoCode_\".concat(stateShopCartModel.user.id))) {\n      actionsShopCartModel.dealPromoCode(\"\".concat(localStorage.getItem(\"promoCode_\".concat(stateShopCartModel.user.id))));\n    }\n  }, [actionsShopCartModel, stateShopCartModel.user.id]);\n  var productNumber = stateShopCartModel.dealProductNumber(stateShopCartModel);\n  var productSubtotal = dealMoney(stateShopCartModel.dealProductTotal(stateShopCartModel));\n  var promoCode = stateShopCartModel.promoCode;\n  var discountProduct = stateShopCartModel.shopCartList.filter(function (v) {\n    var _v$product, _v$product$category, _v$product2, _v$product2$category, _v$product2$category$, _v$product3, _v$product3$category, _v$product3$category$, _v$product3$category$2;\n\n    return [(_v$product = v.product) === null || _v$product === void 0 ? void 0 : (_v$product$category = _v$product.category) === null || _v$product$category === void 0 ? void 0 : _v$product$category.id, (_v$product2 = v.product) === null || _v$product2 === void 0 ? void 0 : (_v$product2$category = _v$product2.category) === null || _v$product2$category === void 0 ? void 0 : (_v$product2$category$ = _v$product2$category.parentCategory) === null || _v$product2$category$ === void 0 ? void 0 : _v$product2$category$.id, (_v$product3 = v.product) === null || _v$product3 === void 0 ? void 0 : (_v$product3$category = _v$product3.category) === null || _v$product3$category === void 0 ? void 0 : (_v$product3$category$ = _v$product3$category.parentCategory) === null || _v$product3$category$ === void 0 ? void 0 : (_v$product3$category$2 = _v$product3$category$.parentCategory) === null || _v$product3$category$2 === void 0 ? void 0 : _v$product3$category$2.id].includes(promoCode.productCategory);\n  });\n  var discountProductAmount = discountProduct.reduce(function (previousValue, currentValue) {\n    var _currentValue$product;\n\n    return previousValue + dealMaybeNumber(currentValue.number) * dealMaybeNumber((_currentValue$product = currentValue.product) === null || _currentValue$product === void 0 ? void 0 : _currentValue$product.priceOut);\n  }, 0); // 计算折扣\n\n  var discountAmountForPromoCode = 0;\n\n  if (discountProduct.length) {\n    // 折扣条件\n    if (promoCode.discountCondition === DiscountConditionEnum.No || promoCode.discountCondition === DiscountConditionEnum.Amount && discountProductAmount > dealMaybeNumber(promoCode.discountConditionAmount)) {\n      discountAmountForPromoCode = promoCode.discountType === DiscountTypeEnum.Amount ? dealMaybeNumber(promoCode.discountAmount) : dealMaybeNumber(promoCode.discountAmount) * discountProductAmount / 100;\n    }\n  }\n\n  useEffect(function () {\n    if (discountAmountForPromoCode) {\n      actionsShopCartModel.setForm(['couponDiscount', discountAmountForPromoCode]);\n    }\n  }, [actionsShopCartModel, discountAmountForPromoCode]);\n  var allTotal = stateShopCartModel.dealProductTotal(stateShopCartModel) - dealMaybeNumber(stateShopCartModel.form.couponDiscount);\n  return __jsx(\"div\", {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 86,\n      columnNumber: 10\n    }\n  }, __jsx(HeaderTitle, {\n    title: '购物车',\n    LeftIcon: CloseIcon,\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 87,\n      columnNumber: 5\n    }\n  }), DealNoAuth(__jsx(React.Fragment, null, !!getLoad(doc.userShopCartList) && __jsx(LinearProgress, {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 92,\n      columnNumber: 44\n    }\n  }) || __jsx(\"div\", {\n    style: {\n      height: '4px'\n    },\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 92,\n      columnNumber: 66\n    }\n  }), __jsx(BScroller, {\n    boxHeight: 'calc(100vh - 65px)',\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 93,\n      columnNumber: 7\n    }\n  }, __jsx(BoxContain, {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 94,\n      columnNumber: 9\n    }\n  }, __jsx(\"div\", {\n    style: {\n      paddingTop: '16px',\n      fontSize: '18px',\n      textAlign: 'center'\n    },\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 95,\n      columnNumber: 11\n    }\n  }, productNumber, ll('件商品')), __jsx(\"div\", {\n    style: {\n      fontSize: '14px',\n      textAlign: 'center',\n      color: grey[600],\n      marginTop: '8px',\n      marginBottom: '10px'\n    },\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 100,\n      columnNumber: 11\n    }\n  }, ll('小计'), \":\", productSubtotal), stateShopCartModel.shopCartList.map(function (value) {\n    return __jsx(CartProduct, {\n      key: \"CartProduct_\".concat(value.id),\n      shopCart: value,\n      __self: _this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 111,\n        columnNumber: 57\n      }\n    });\n  }), __jsx(TextField, {\n    style: {\n      marginTop: '10px'\n    },\n    fullWidth: true,\n    label: ll('运送方式'),\n    select: true,\n    value: stateShopCartModel.form.pickUpType,\n    onChange: function onChange(event) {\n      actionsShopCartModel.setForm(['pickUpType', event.target.value]);\n      actionsShopCartModel.setForm(['addressId', stateShopCartModel.initAddressId(fpMerge(stateShopCartModel, {\n        form: {\n          pickUpType: event.target.value\n        }\n      }))]);\n    },\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 115,\n      columnNumber: 11\n    }\n  }, __jsx(MenuItem, {\n    value: PickUpTypeEnum.Self,\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 130,\n      columnNumber: 13\n    }\n  }, ll(getPickUpTypeName(PickUpTypeEnum.Self))), __jsx(MenuItem, {\n    value: PickUpTypeEnum.Delivery,\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 133,\n      columnNumber: 13\n    }\n  }, ll(getPickUpTypeName(PickUpTypeEnum.Delivery)))), __jsx(Title, {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 137,\n      columnNumber: 11\n    }\n  }, ll('达人卡和优惠券')), __jsx(PromoCode, {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 138,\n      columnNumber: 11\n    }\n  }, __jsx(\"main\", {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 139,\n      columnNumber: 13\n    }\n  }, stateShopCartModel.promoCode.title), __jsx(\"aside\", {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 140,\n      columnNumber: 13\n    }\n  }, ll('code'), \": \", stateShopCartModel.promoCode.code)), __jsx(Space, {\n    h: 8,\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 142,\n      columnNumber: 11\n    }\n  }), __jsx(Button, {\n    variant: 'outlined',\n    onClick: /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n      return _regeneratorRuntime.wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              _context.next = 2;\n              return actionsInputPromoCodeModel.openClick(function (promoCode) {\n                return actionsShopCartModel.dealPromoCode(promoCode);\n              });\n\n            case 2:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee);\n    })),\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 143,\n      columnNumber: 11\n    }\n  }, ll(stateShopCartModel.promoCode.code ? '重新输入' : '输入验证码')), __jsx(InputPromoCodeDialog, {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 151,\n      columnNumber: 11\n    }\n  }), __jsx(Title, {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 152,\n      columnNumber: 11\n    }\n  }, ll('预估价格')), __jsx(Money, {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 153,\n      columnNumber: 11\n    }\n  }, __jsx(\"aside\", {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 154,\n      columnNumber: 13\n    }\n  }, ll('小计')), __jsx(\"main\", {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 155,\n      columnNumber: 13\n    }\n  }, productSubtotal)), __jsx(Space, {\n    h: 10,\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 157,\n      columnNumber: 11\n    }\n  }), __jsx(Money, {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 158,\n      columnNumber: 11\n    }\n  }, __jsx(\"aside\", {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 159,\n      columnNumber: 13\n    }\n  }, ll('折扣')), __jsx(\"main\", {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 160,\n      columnNumber: 13\n    }\n  }, dealMoney(stateShopCartModel.form.couponDiscount))), __jsx(\"div\", {\n    style: {\n      width: '100%',\n      height: '10px'\n    },\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 162,\n      columnNumber: 11\n    }\n  }), __jsx(Money, {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 163,\n      columnNumber: 11\n    }\n  }, __jsx(\"aside\", {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 164,\n      columnNumber: 13\n    }\n  }, ll('总计')), __jsx(\"main\", {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 165,\n      columnNumber: 13\n    }\n  }, dealMoney(allTotal))), __jsx(Title, {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 167,\n      columnNumber: 11\n    }\n  }, ll('下次购买的商品')), stateShopCartModel.shopCartListNext.map(function (value) {\n    return __jsx(CartProduct, {\n      key: \"CartProduct_\".concat(value.id),\n      shopCart: value,\n      __self: _this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 168,\n        columnNumber: 61\n      }\n    });\n  }), __jsx(\"div\", {\n    style: {\n      width: '100%',\n      height: '100px'\n    },\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 171,\n      columnNumber: 11\n    }\n  }))), __jsx(FixFooter, {\n    boxShadow: 1,\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 174,\n      columnNumber: 7\n    }\n  }, __jsx(Button, {\n    variant: 'contained',\n    color: 'secondary',\n    fullWidth: true,\n    disabled: productNumber === 0,\n    onClick: function onClick() {\n      return actionsShopCartModel.updatePageType(pageTypeEnum.order);\n    },\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 175,\n      columnNumber: 9\n    }\n  }, ll('去结算'))), __jsx(UpdateShopCart, {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 183,\n      columnNumber: 7\n    }\n  }))));\n};\n\n_s(ShopCartPage, \"ZH3HXyTv2F9723r4TLjxvfEyqSE=\", false, function () {\n  return [useStoreModel, useStoreModel];\n});\n\n_c6 = ShopCartPage;\n\nvar _c, _c2, _c3, _c4, _c5, _c6;\n\n$RefreshReg$(_c, \"BoxContain\");\n$RefreshReg$(_c2, \"Title\");\n$RefreshReg$(_c3, \"PromoCode\");\n$RefreshReg$(_c4, \"Money\");\n$RefreshReg$(_c5, \"FixFooter\");\n$RefreshReg$(_c6, \"ShopCartPage\");","map":{"version":3,"sources":["D:/code/zw/zw_client_web/utils/view/m/cart/shopCart.tsx"],"names":["React","useEffect","doc","dealMaybeNumber","dealMoney","fpMerge","useStoreModel","ll","HeaderTitle","Box","Button","LinearProgress","MenuItem","TextField","grey","styled","DiscountConditionEnum","DiscountTypeEnum","getPickUpTypeName","PickUpTypeEnum","CartProduct","BScroller","pageTypeEnum","shopCartModel","DealNoAuth","Space","InputPromoCodeDialog","inputPromoCodeModel","CloseIcon","UpdateShopCart","BoxContain","section","Title","div","PromoCode","Money","FixFooter","ShopCartPage","stateShopCartModel","state","actionsShopCartModel","actions","getLoad","actionsInputPromoCodeModel","shopCartList","length","getList","user","id","localStorage","getItem","dealPromoCode","productNumber","dealProductNumber","productSubtotal","dealProductTotal","promoCode","discountProduct","filter","v","product","category","parentCategory","includes","productCategory","discountProductAmount","reduce","previousValue","currentValue","number","priceOut","discountAmountForPromoCode","discountCondition","No","Amount","discountConditionAmount","discountType","discountAmount","setForm","allTotal","form","couponDiscount","userShopCartList","height","paddingTop","fontSize","textAlign","color","marginTop","marginBottom","map","value","pickUpType","event","target","initAddressId","Self","Delivery","title","code","openClick","width","shopCartListNext","updatePageType","order"],"mappings":"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","sourcesContent":["import React, {useEffect} from 'react'\r\nimport {doc} from '../../../graphqlTypes/doc'\r\nimport {dealMaybeNumber, dealMoney, fpMerge} from '../../../tools/utils'\r\nimport {useStoreModel} from '../../../ModelAction/useStore'\r\nimport {ll} from '../../../tools/dealKey'\r\nimport {HeaderTitle} from '../../../components/HeaderTitle/HeaderTitle'\r\nimport {Box, Button, LinearProgress, MenuItem, TextField} from '@material-ui/core'\r\nimport {grey} from '@material-ui/core/colors'\r\nimport styled from 'styled-components'\r\nimport {DiscountConditionEnum, DiscountTypeEnum, getPickUpTypeName, PickUpTypeEnum} from '../../../ss_common/enum'\r\nimport {CartProduct} from './CartProduct'\r\nimport {BScroller} from '../../../components/BScroll/BScroller'\r\nimport {pageTypeEnum, shopCartModel} from './index'\r\nimport {DealNoAuth} from '../../../components/NoAuth/NoAuth'\r\nimport {Space} from '../../../components/Box/Box'\r\nimport {InputPromoCodeDialog, inputPromoCodeModel} from './components/InputPromoCode'\r\nimport CloseIcon from '@material-ui/icons/Close'\r\nimport {UpdateShopCart} from '../../../components/ProductItem/UpdateShopCart'\r\n\r\nconst BoxContain = styled.section`\r\n  padding: 0 20px;\r\n`\r\nconst Title = styled.div`\r\n  font-size: 18px;\r\n  font-weight: bold;\r\n  margin: 16px 0 12px;\r\n`\r\nconst PromoCode = styled.div`\r\n  display: flex;\r\n  > aside {\r\n    // background: ${grey[100]};\r\n    margin-left: 8px;\r\n  }\r\n`\r\nconst Money = styled.div`\r\n  display: flex;\r\n  justify-content: space-between;\r\n`\r\nconst FixFooter = styled(Box)`\r\n  padding: 20px;\r\n  position: fixed;\r\n  bottom: 0;\r\n  width: 100vw;\r\n  box-sizing: border-box;\r\n  background: #fff;\r\n`\r\n\r\nexport const ShopCartPage = () => {\r\n  const {state: stateShopCartModel, actions: actionsShopCartModel, getLoad} = useStoreModel(shopCartModel)\r\n  const {actions: actionsInputPromoCodeModel} = useStoreModel(inputPromoCodeModel)\r\n\r\n  useEffect(() => {\r\n    if (stateShopCartModel.shopCartList.length === 0) {\r\n      actionsShopCartModel.getList()\r\n    }\r\n  }, [actionsShopCartModel, stateShopCartModel.shopCartList.length])\r\n  useEffect(() => {\r\n    if (stateShopCartModel.user.id && localStorage.getItem(`promoCode_${stateShopCartModel.user.id}`)) {\r\n      actionsShopCartModel.dealPromoCode(`${localStorage.getItem(`promoCode_${stateShopCartModel.user.id}`)}`)\r\n    }\r\n  }, [actionsShopCartModel, stateShopCartModel.user.id])\r\n  const productNumber = stateShopCartModel.dealProductNumber(stateShopCartModel)\r\n  const productSubtotal = dealMoney(stateShopCartModel.dealProductTotal(stateShopCartModel))\r\n\r\n  const promoCode = stateShopCartModel.promoCode\r\n  const discountProduct = stateShopCartModel.shopCartList.filter(v => [v.product?.category?.id, v.product?.category?.parentCategory?.id, v.product?.category?.parentCategory?.parentCategory?.id].includes(promoCode.productCategory))\r\n  const discountProductAmount = discountProduct.reduce((previousValue, currentValue) => {\r\n    return previousValue + dealMaybeNumber(currentValue.number) * dealMaybeNumber(currentValue.product?.priceOut)\r\n  }, 0)\r\n  // 计算折扣\r\n  let discountAmountForPromoCode = 0\r\n  if (discountProduct.length) {\r\n    // 折扣条件\r\n    if (promoCode.discountCondition === DiscountConditionEnum.No\r\n        || (promoCode.discountCondition === DiscountConditionEnum.Amount && discountProductAmount > dealMaybeNumber(promoCode.discountConditionAmount))) {\r\n      discountAmountForPromoCode = promoCode.discountType === DiscountTypeEnum.Amount ? dealMaybeNumber(promoCode.discountAmount) : (dealMaybeNumber(promoCode.discountAmount) * discountProductAmount / 100)\r\n    }\r\n  }\r\n  useEffect(() => {\r\n    if (discountAmountForPromoCode) {\r\n      actionsShopCartModel.setForm(['couponDiscount', discountAmountForPromoCode])\r\n    }\r\n  }, [actionsShopCartModel, discountAmountForPromoCode])\r\n  const allTotal = stateShopCartModel.dealProductTotal(stateShopCartModel) - dealMaybeNumber(stateShopCartModel.form.couponDiscount)\r\n\r\n  return <div>\r\n    <HeaderTitle\r\n        title={'购物车'}\r\n        LeftIcon={CloseIcon}\r\n    />\r\n    {DealNoAuth(<>\r\n      {(!!getLoad(doc.userShopCartList) && <LinearProgress/>) || <div style={{height: '4px'}}/>}\r\n      <BScroller boxHeight={'calc(100vh - 65px)'}>\r\n        <BoxContain>\r\n          <div\r\n              style={{paddingTop: '16px', fontSize: '18px', textAlign: 'center'}}\r\n          >\r\n            {productNumber}{ll('件商品')}\r\n          </div>\r\n          <div\r\n              style={{\r\n                fontSize: '14px',\r\n                textAlign: 'center',\r\n                color: grey[600],\r\n                marginTop: '8px',\r\n                marginBottom: '10px',\r\n              }}\r\n          >\r\n            {ll('小计')}:{productSubtotal}\r\n          </div>\r\n          {stateShopCartModel.shopCartList.map(value => <CartProduct\r\n              key={`CartProduct_${value.id}`}\r\n              shopCart={value}/>)\r\n          }\r\n          <TextField\r\n              style={{marginTop: '10px'}}\r\n              fullWidth={true}\r\n              label={ll('运送方式')}\r\n              select={true}\r\n              value={stateShopCartModel.form.pickUpType}\r\n              onChange={event => {\r\n                actionsShopCartModel.setForm(['pickUpType', event.target.value])\r\n                actionsShopCartModel.setForm(['addressId', stateShopCartModel.initAddressId(fpMerge(stateShopCartModel, {\r\n                  form: {\r\n                    pickUpType: event.target.value,\r\n                  },\r\n                }))])\r\n              }}\r\n          >\r\n            <MenuItem\r\n                value={PickUpTypeEnum.Self}\r\n            >{ll(getPickUpTypeName(PickUpTypeEnum.Self))}</MenuItem>\r\n            <MenuItem\r\n                value={PickUpTypeEnum.Delivery}\r\n            >{ll(getPickUpTypeName(PickUpTypeEnum.Delivery))}</MenuItem>\r\n          </TextField>\r\n          <Title>{ll('达人卡和优惠券')}</Title>\r\n          <PromoCode>\r\n            <main>{stateShopCartModel.promoCode.title}</main>\r\n            <aside>{ll('code')}: {stateShopCartModel.promoCode.code}</aside>\r\n          </PromoCode>\r\n          <Space h={8}/>\r\n          <Button\r\n              variant={'outlined'}\r\n              onClick={async () => {\r\n                await actionsInputPromoCodeModel.openClick((promoCode: string) => {\r\n                  return actionsShopCartModel.dealPromoCode(promoCode)\r\n                })\r\n              }}\r\n          >{ll(stateShopCartModel.promoCode.code ? '重新输入' : '输入验证码')}</Button>\r\n          <InputPromoCodeDialog/>\r\n          <Title>{ll('预估价格')}</Title>\r\n          <Money>\r\n            <aside>{ll('小计')}</aside>\r\n            <main>{productSubtotal}</main>\r\n          </Money>\r\n          <Space h={10}/>\r\n          <Money>\r\n            <aside>{ll('折扣')}</aside>\r\n            <main>{dealMoney(stateShopCartModel.form.couponDiscount)}</main>\r\n          </Money>\r\n          <div style={{width: '100%', height: '10px'}}/>\r\n          <Money>\r\n            <aside>{ll('总计')}</aside>\r\n            <main>{dealMoney(allTotal)}</main>\r\n          </Money>\r\n          <Title>{ll('下次购买的商品')}</Title>\r\n          {stateShopCartModel.shopCartListNext.map(value => <CartProduct\r\n              key={`CartProduct_${value.id}`}\r\n              shopCart={value}/>)}\r\n          <div style={{width: '100%', height: '100px'}}/>\r\n        </BoxContain>\r\n      </BScroller>\r\n      <FixFooter boxShadow={1}>\r\n        <Button\r\n            variant={'contained'}\r\n            color={'secondary'}\r\n            fullWidth={true}\r\n            disabled={productNumber === 0}\r\n            onClick={() => actionsShopCartModel.updatePageType(pageTypeEnum.order)}\r\n        >{ll('去结算')}</Button>\r\n      </FixFooter>\r\n      <UpdateShopCart/>\r\n    </>)}\r\n  </div>\r\n}\r\n"]},"metadata":{},"sourceType":"module"}