{"ast":null,"code":"var __jsx = React.createElement;\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nimport React, { useEffect } from 'react';\nimport StarRoundedIcon from '@material-ui/icons/StarRounded';\nimport StarBorderRoundedIcon from '@material-ui/icons/StarBorderRounded';\nimport { useRouter } from 'next/router';\nimport { modelFactory } from '../../../ModelAction/modelUtil';\nimport { doc, getDataConfig } from '../../../graphqlTypes/doc';\nimport { useStoreModel } from '../../../ModelAction/useStore';\nimport { dealMoney, fpMergePre } from '../../../tools/utils';\nimport CusCarousel from '../../../components/Swipe/Swipe';\nimport { HeaderTitle } from '../../../components/HeaderTitle/HeaderTitle';\nimport styled from 'styled-components';\nimport { ll } from '../../../tools/dealKey';\nimport { mpStyle } from '../../../style/common';\nimport { grey } from '@material-ui/core/colors';\nimport { Button } from '@material-ui/core';\nimport { GroupOrderPage, groupOrderPageModel } from './groupOrderPage';\nimport { DictTypeEnum } from '../../../ss_common/enum';\n\nconst dealDiscount = num => {\n  var _ref;\n\n  return ((_ref = 100 - num) !== null && _ref !== void 0 ? _ref : 0) / 100;\n};\n\nexport const dealGroupNumbers = product => {\n  var _product$groupAmount, _product$groupPrecisi;\n\n  return ~~(((_product$groupAmount = product.groupAmount) !== null && _product$groupAmount !== void 0 ? _product$groupAmount : 0) / ((_product$groupPrecisi = product.groupPrecision) !== null && _product$groupPrecisi !== void 0 ? _product$groupPrecisi : 1));\n};\nexport const groupProductModel = modelFactory('groupProductModel', {\n  product: {},\n  groupQueueList: [],\n  selectNum: 0,\n  selectQueueId: '',\n  numDiscount: 1,\n  groupDiscount: 1,\n  groupDiscountConfig: {},\n  dealDiscountAmountUnit: state => {\n    var _state$product$priceO;\n\n    return ((_state$product$priceO = state.product.priceOut) !== null && _state$product$priceO !== void 0 ? _state$product$priceO : 0) * state.numDiscount * state.groupDiscount;\n  },\n  dealDiscountAmount: state => {\n    var _state$product$priceO2;\n\n    return ((_state$product$priceO2 = state.product.priceOut) !== null && _state$product$priceO2 !== void 0 ? _state$product$priceO2 : 0) * state.selectNum * dealGroupNumbers(state.product) * state.numDiscount * state.groupDiscount;\n  }\n}, {\n  getData: async (value, option) => {\n    var _res$productListByIds, _res$productListByIds2, _groupQueueList$group, _groupQueueList$group2, _res2$getDataConfig;\n\n    const res = await option.query(doc.productListByIds, {\n      ids: [value]\n    });\n    const groupQueueList = await option.query(doc.groupQueueList, {\n      groupQueueItemInput: {\n        product: {\n          id: value\n        }\n      }\n    });\n    const res2 = await option.query(getDataConfig, {\n      data: {\n        type: DictTypeEnum.GroupPrecision\n      }\n    }, {});\n    option.setData(fpMergePre({\n      product: (_res$productListByIds = res === null || res === void 0 ? void 0 : (_res$productListByIds2 = res.productListByIds) === null || _res$productListByIds2 === void 0 ? void 0 : _res$productListByIds2.list[0]) !== null && _res$productListByIds !== void 0 ? _res$productListByIds : {},\n      groupQueueList: (_groupQueueList$group = groupQueueList === null || groupQueueList === void 0 ? void 0 : (_groupQueueList$group2 = groupQueueList.groupQueueList) === null || _groupQueueList$group2 === void 0 ? void 0 : _groupQueueList$group2.sort((a, b) => {\n        var _a$sumFillAmount, _b$sumFillAmount;\n\n        return ((_a$sumFillAmount = a.sumFillAmount) !== null && _a$sumFillAmount !== void 0 ? _a$sumFillAmount : 0) - ((_b$sumFillAmount = b.sumFillAmount) !== null && _b$sumFillAmount !== void 0 ? _b$sumFillAmount : 0);\n      })) !== null && _groupQueueList$group !== void 0 ? _groupQueueList$group : [],\n      groupDiscountConfig: res2 === null || res2 === void 0 ? void 0 : (_res2$getDataConfig = res2.getDataConfig) === null || _res2$getDataConfig === void 0 ? void 0 : _res2$getDataConfig.value\n    }));\n  },\n  updateSelectNum: (value, option) => {\n    var _reverse$find$id, _reverse, _reverse$find, _option$data$groupQue, _option$data$groupQue2, _dealDiscount, _groupDiscountConfig, _groupDiscountConfig$, _option$data$product$2;\n\n    const groupDiscountConfig = option.data.groupDiscountConfig;\n    const selectNum = value === option.data.selectNum ? 0 : value;\n    const selectQueueId = value === option.data.selectNum ? '' : (_reverse$find$id = (_reverse = [...option.data.groupQueueList].reverse()) === null || _reverse === void 0 ? void 0 : (_reverse$find = _reverse.find(v => {\n      var _v$sumFillAmount, _option$data$product$, _option$data, _option$data$product;\n\n      return ((_v$sumFillAmount = v.sumFillAmount) !== null && _v$sumFillAmount !== void 0 ? _v$sumFillAmount : 0) + value <= ((_option$data$product$ = (_option$data = option.data) === null || _option$data === void 0 ? void 0 : (_option$data$product = _option$data.product) === null || _option$data$product === void 0 ? void 0 : _option$data$product.groupPrecision) !== null && _option$data$product$ !== void 0 ? _option$data$product$ : 0);\n    })) === null || _reverse$find === void 0 ? void 0 : _reverse$find.id) !== null && _reverse$find$id !== void 0 ? _reverse$find$id : '';\n    option.setData(fpMergePre({\n      selectNum,\n      selectQueueId,\n      groupDiscount: ((_option$data$groupQue = (_option$data$groupQue2 = option.data.groupQueueList.find(value1 => value1.id === selectQueueId)) === null || _option$data$groupQue2 === void 0 ? void 0 : _option$data$groupQue2.sumFillAmount) !== null && _option$data$groupQue !== void 0 ? _option$data$groupQue : 0) + selectNum === option.data.product.groupPrecision ? dealDiscount(groupDiscountConfig.groupDiscount) : 1,\n      numDiscount: (_dealDiscount = dealDiscount(groupDiscountConfig === null || groupDiscountConfig === void 0 ? void 0 : (_groupDiscountConfig = groupDiscountConfig[(_option$data$product$2 = option.data.product.groupPrecision) !== null && _option$data$product$2 !== void 0 ? _option$data$product$2 : 0]) === null || _groupDiscountConfig === void 0 ? void 0 : (_groupDiscountConfig$ = _groupDiscountConfig.discount) === null || _groupDiscountConfig$ === void 0 ? void 0 : _groupDiscountConfig$[selectNum])) !== null && _dealDiscount !== void 0 ? _dealDiscount : 1\n    }));\n  },\n  clearData: (value, option) => {\n    option.setData(fpMergePre({\n      selectNum: 0,\n      selectQueueId: '',\n      numDiscount: 1,\n      groupDiscount: 1\n    }));\n  },\n  submit: async ({\n    orderInfoItemInput\n  }, option) => {\n    return await option.mutate(doc.saveGroupOrder, {\n      orderInfoItemInput: _objectSpread({}, orderInfoItemInput),\n      groupOrderItemInput: {\n        orderGroupAmount: option.data.selectNum\n      },\n      groupQueueItemInput: _objectSpread({\n        product: option.data.product\n      }, option.data.selectQueueId ? {\n        id: option.data.selectQueueId\n      } : {})\n    });\n  }\n});\nconst PriceRed = styled.div.withConfig({\n  displayName: \"id__PriceRed\",\n  componentId: \"ghx5mg-0\"\n})([\"background:\", \";color:white;display:grid;grid-template-columns:1fr 120px;grid-template-rows:repeat(2,30px);align-items:center;> main{grid-area:1/1/3/2;padding-left:20px;> span{margin-left:16px;}}\"], mpStyle.red);\nconst Name = styled.div.withConfig({\n  displayName: \"id__Name\",\n  componentId: \"ghx5mg-1\"\n})([\"padding:16px 20px;display:flex;align-items:flex-end;> main{font-size:22px;margin-right:8px;flex-shrink:0;}> section{> span{padding:0 4px;background:\", \";border-radius:4px;position:relative;bottom:-4px;margin-left:8px;display:inline-flex;align-items:center;}}\"], grey['700']);\n\nconst YellowStar = () => __jsx(StarRoundedIcon, {\n  fontSize: 'small',\n  style: {\n    color: '#FDD334'\n  }\n});\n\nconst Title = styled.header.withConfig({\n  displayName: \"id__Title\",\n  componentId: \"ghx5mg-2\"\n})([\"font-size:20px;\"]);\nconst GroupQueueBox = styled.div.withConfig({\n  displayName: \"id__GroupQueueBox\",\n  componentId: \"ghx5mg-3\"\n})([\"padding:16px;\"]);\nconst SmartMatch = styled.div.withConfig({\n  displayName: \"id__SmartMatch\",\n  componentId: \"ghx5mg-4\"\n})([\"padding:16px 16px 90px;> section{margin-top:8px;display:flex;align-items:center;}> main{> svg{font-size:3.0rem;}}\"]);\nconst Price = styled.div.withConfig({\n  displayName: \"id__Price\",\n  componentId: \"ghx5mg-5\"\n})([\"margin-top:8px;display:flex;justify-content:space-between;align-items:center;> main{font-weight:bold;}> main,section{> *{text-align:center;}}\"]);\nconst Submit = styled.div.withConfig({\n  displayName: \"id__Submit\",\n  componentId: \"ghx5mg-6\"\n})([\"position:fixed;height:60px;bottom:0;width:100vw;background:white;border-top:1px solid \", \";display:flex;align-items:center;justify-content:space-between;box-shadow:\", \";> aside{padding-left:16px;color:\", \";}\"], mpStyle.red, mpStyle.shadow['1'], mpStyle.red);\nconst GroupQueueListBox = styled.div.withConfig({\n  displayName: \"id__GroupQueueListBox\",\n  componentId: \"ghx5mg-7\"\n})([\"margin-top:16px;border-radius:8px;background:\", \";display:flex;justify-content:space-between;align-items:center;padding:0 8px;\"], prop => prop.select ? `linear-gradient(to right, ${mpStyle.red}, #FC7361)` : grey['200']);\nexport const GroupProduct = () => {\n  var _ref2, _router$query, _product$img, _product$priceOut;\n\n  const router = useRouter();\n  const id = (_ref2 = (_router$query = router.query) === null || _router$query === void 0 ? void 0 : _router$query.id) !== null && _ref2 !== void 0 ? _ref2 : '';\n  const {\n    actions: actionsGroupProduct,\n    state: stateGroupProduct\n  } = useStoreModel(groupProductModel);\n  useEffect(() => {\n    actionsGroupProduct.getData(id);\n  }, [actionsGroupProduct, id]);\n  const {\n    actions: actionsGroupOrderPageModel\n  } = useStoreModel(groupOrderPageModel);\n  const product = stateGroupProduct.product; // useEffect(() => {\n  //   actionsGroupProduct.updateSelectNum(2)\n  //   actionsGroupOrderPageModel.open()\n  // }, [])\n\n  return __jsx(\"div\", null, __jsx(HeaderTitle, {\n    title: '产品详情'\n  }), __jsx(CusCarousel, {\n    height: '240px',\n    dataList: product === null || product === void 0 ? void 0 : (_product$img = product.img) === null || _product$img === void 0 ? void 0 : _product$img.map(v => _objectSpread(_objectSpread({}, v), {}, {\n      imgUrl: v === null || v === void 0 ? void 0 : v.url\n    }))\n  }), __jsx(PriceRed, null, __jsx(\"main\", null, ll('基准价格'), __jsx(\"span\", null, dealMoney(product.priceOut), \"/\", product.groupAmountUnitString)), __jsx(\"aside\", null, ll('已成团'), stateGroupProduct.groupQueueList.filter(v => v.sumFillAmount === (product === null || product === void 0 ? void 0 : product.groupPrecision)).length, ll('单')), __jsx(\"aside\", null, ll('拼团中'), stateGroupProduct.groupQueueList.filter(v => {\n    var _v$sumFillAmount2, _product$groupPrecisi2;\n\n    return ((_v$sumFillAmount2 = v.sumFillAmount) !== null && _v$sumFillAmount2 !== void 0 ? _v$sumFillAmount2 : 0) < ((_product$groupPrecisi2 = product === null || product === void 0 ? void 0 : product.groupPrecision) !== null && _product$groupPrecisi2 !== void 0 ? _product$groupPrecisi2 : 0);\n  }).length, ll('单'))), __jsx(Name, null, __jsx(\"main\", null, product.name), __jsx(\"section\", null, product.groupRemark, \"/\", product.groupAmount, product.groupAmountUnitString, \" \", `每一份${dealGroupNumbers(product)}${product.groupAmountUnitString}`, __jsx(\"br\", null), ll('分团精度'), __jsx(\"span\", null, [...Array(product.groupPrecision)].map((v, i) => i).map(value => __jsx(YellowStar, {\n    key: value\n  }))))), __jsx(GroupQueueBox, null, __jsx(Title, null, ll('拼团中')), stateGroupProduct.groupQueueList.filter(v => {\n    var _v$sumFillAmount3, _product$groupPrecisi3;\n\n    return ((_v$sumFillAmount3 = v.sumFillAmount) !== null && _v$sumFillAmount3 !== void 0 ? _v$sumFillAmount3 : 0) < ((_product$groupPrecisi3 = product === null || product === void 0 ? void 0 : product.groupPrecision) !== null && _product$groupPrecisi3 !== void 0 ? _product$groupPrecisi3 : 0);\n  }).map(groupQueue => {\n    var _groupQueue$sumFillAm2;\n\n    const select = groupQueue.id === stateGroupProduct.selectQueueId;\n    return __jsx(GroupQueueListBox, {\n      select: select,\n      key: `GroupQueueListBox${groupQueue.id}`\n    }, __jsx(\"aside\", null, [...Array(product.groupPrecision)].map((v, i) => i).map(value => {\n      var _groupQueue$sumFillAm;\n\n      return value + 1 > ((_groupQueue$sumFillAm = groupQueue.sumFillAmount) !== null && _groupQueue$sumFillAm !== void 0 ? _groupQueue$sumFillAm : 0) + (select ? stateGroupProduct.selectNum : 0) ? __jsx(StarBorderRoundedIcon, {\n        key: `clickStar${value}`,\n        fontSize: 'large',\n        onClick: () => actionsGroupProduct.updateSelectNum(value + 1),\n        style: {\n          color: select ? '#fff' : '#000'\n        }\n      }) : __jsx(StarRoundedIcon, {\n        key: `clickStar${value}`,\n        style: {\n          color: '#FDD334'\n        },\n        fontSize: 'large',\n        onClick: () => actionsGroupProduct.updateSelectNum(value + 1)\n      });\n    })), __jsx(\"footer\", null, ll(((_groupQueue$sumFillAm2 = groupQueue.sumFillAmount) !== null && _groupQueue$sumFillAm2 !== void 0 ? _groupQueue$sumFillAm2 : 0) + (select ? stateGroupProduct.selectNum : 0) === product.groupPrecision ? '成团啦' : '未成团')));\n  })), __jsx(SmartMatch, null, __jsx(\"header\", null, __jsx(Title, null, ll('智能匹配'))), __jsx(\"section\", null, ll('请点击'), __jsx(StarBorderRoundedIcon, null), ll('确定您需要的份数')), __jsx(\"main\", null, [...Array(product.groupPrecision)].map((v, i) => i).map(value => value + 1 > stateGroupProduct.selectNum ? __jsx(StarBorderRoundedIcon, {\n    key: `clickStar${value}`,\n    fontSize: 'large',\n    onClick: () => actionsGroupProduct.updateSelectNum(value + 1)\n  }) : __jsx(StarRoundedIcon, {\n    key: `clickStar${value}`,\n    style: {\n      color: '#FDD334'\n    },\n    fontSize: 'large',\n    onClick: () => actionsGroupProduct.updateSelectNum(value + 1)\n  }))), __jsx(Price, null, __jsx(\"main\", null, __jsx(\"header\", null, dealMoney(stateGroupProduct.dealDiscountAmountUnit(stateGroupProduct))), __jsx(\"footer\", null, ll('折后价格'))), __jsx(\"div\", null, \"=\"), __jsx(\"section\", null, __jsx(\"header\", null, dealMoney((_product$priceOut = product.priceOut) !== null && _product$priceOut !== void 0 ? _product$priceOut : 0)), __jsx(\"footer\", null, ll('基准价格'))), __jsx(\"div\", null, \"x\"), __jsx(\"section\", null, __jsx(\"header\", null, stateGroupProduct.numDiscount), __jsx(\"footer\", null, ll('份数折扣'))), __jsx(\"div\", null, \"x\"), __jsx(\"section\", null, __jsx(\"header\", null, stateGroupProduct.groupDiscount), __jsx(\"footer\", null, ll('成团折上折'))))), __jsx(Submit, null, __jsx(\"aside\", null, ll('选择了'), stateGroupProduct.selectNum, ll('份')), __jsx(Button, {\n    disabled: stateGroupProduct.selectNum === 0,\n    style: {\n      height: '100%',\n      padding: '0 32px',\n      borderRadius: '0',\n      fontSize: '18px'\n    },\n    color: 'secondary',\n    variant: 'contained',\n    onClick: () => {\n      actionsGroupOrderPageModel.open();\n    }\n  }, ll('去结算'))), __jsx(GroupOrderPage, null));\n};","map":null,"metadata":{},"sourceType":"module"}