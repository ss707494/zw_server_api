{"ast":null,"code":"import _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\nimport _toConsumableArray from \"@babel/runtime/helpers/esm/toConsumableArray\";\nimport _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/esm/asyncToGenerator\";\nvar __jsx = React.createElement;\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nimport React, { useEffect } from 'react';\nimport StarRoundedIcon from '@material-ui/icons/StarRounded';\nimport StarBorderRoundedIcon from '@material-ui/icons/StarBorderRounded';\nimport { useRouter } from 'next/router';\nimport { modelFactory } from '../../../ModelAction/modelUtil';\nimport { doc, getDataConfig } from '../../../graphqlTypes/doc';\nimport { useStoreModel } from '../../../ModelAction/useStore';\nimport { dealMoney, fpMergePre } from '../../../tools/utils';\nimport CusCarousel from '../../../components/Swipe/Swipe';\nimport { HeaderTitle } from '../../../components/HeaderTitle/HeaderTitle';\nimport styled from 'styled-components';\nimport { ll } from '../../../tools/dealKey';\nimport { mpStyle } from '../../../style/common';\nimport { grey } from '@material-ui/core/colors';\nimport { Button } from '@material-ui/core';\nimport { GroupOrderPage, groupOrderPageModel } from './groupOrderPage';\nimport { DictTypeEnum } from '../../../ss_common/enum';\nimport { GroupQueueList } from './groupQueueList';\nimport { PriceBox } from '../../pc/groupProduct/[id]';\nimport { ShopCartModel } from '../cart';\n\nvar dealDiscount = function dealDiscount(num) {\n  var _ref;\n\n  return ((_ref = 100 - num) !== null && _ref !== void 0 ? _ref : 0) / 100;\n};\n\nexport var dealGroupNumbers = function dealGroupNumbers(product) {\n  var _product$groupAmount, _product$groupPrecisi;\n\n  return ~~(((_product$groupAmount = product.groupAmount) !== null && _product$groupAmount !== void 0 ? _product$groupAmount : 0) / ((_product$groupPrecisi = product.groupPrecision) !== null && _product$groupPrecisi !== void 0 ? _product$groupPrecisi : 1));\n};\nexport var groupProductModel = modelFactory('groupProductModel', {\n  product: {},\n  groupQueueList: [],\n  selectNum: 0,\n  selectQueueId: '',\n  numDiscount: 1,\n  groupDiscount: 1,\n  groupDiscountConfig: {},\n  dealDiscountAmountUnit: function dealDiscountAmountUnit(state) {\n    var _state$product$priceO;\n\n    return ((_state$product$priceO = state.product.priceOut) !== null && _state$product$priceO !== void 0 ? _state$product$priceO : 0) * state.numDiscount * state.groupDiscount;\n  },\n  dealDiscountAmount: function dealDiscountAmount(state) {\n    var _state$product$priceO2;\n\n    return ((_state$product$priceO2 = state.product.priceOut) !== null && _state$product$priceO2 !== void 0 ? _state$product$priceO2 : 0) * state.selectNum * dealGroupNumbers(state.product) * state.numDiscount * state.groupDiscount;\n  }\n}, {\n  getData: function () {\n    var _getData = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(value, option) {\n      var _res$productListByIds, _res$productListByIds2, _groupQueueList$group, _groupQueueList$group2, _res2$getDataConfig;\n\n      var res, groupQueueList, res2;\n      return _regeneratorRuntime.wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              _context.next = 2;\n              return option.query(doc.productListByIds, {\n                ids: [value]\n              });\n\n            case 2:\n              res = _context.sent;\n              _context.next = 5;\n              return option.query(doc.groupQueueList, {\n                groupQueueItemInput: {\n                  product: {\n                    id: value\n                  }\n                }\n              });\n\n            case 5:\n              groupQueueList = _context.sent;\n              _context.next = 8;\n              return option.query(getDataConfig, {\n                data: {\n                  type: DictTypeEnum.GroupPrecision\n                }\n              }, {});\n\n            case 8:\n              res2 = _context.sent;\n              option.setData(fpMergePre({\n                product: (_res$productListByIds = res === null || res === void 0 ? void 0 : (_res$productListByIds2 = res.productListByIds) === null || _res$productListByIds2 === void 0 ? void 0 : _res$productListByIds2.list[0]) !== null && _res$productListByIds !== void 0 ? _res$productListByIds : {},\n                groupQueueList: (_groupQueueList$group = groupQueueList === null || groupQueueList === void 0 ? void 0 : (_groupQueueList$group2 = groupQueueList.groupQueueList) === null || _groupQueueList$group2 === void 0 ? void 0 : _groupQueueList$group2.sort(function (a, b) {\n                  var _a$sumFillAmount, _b$sumFillAmount;\n\n                  return ((_a$sumFillAmount = a.sumFillAmount) !== null && _a$sumFillAmount !== void 0 ? _a$sumFillAmount : 0) - ((_b$sumFillAmount = b.sumFillAmount) !== null && _b$sumFillAmount !== void 0 ? _b$sumFillAmount : 0);\n                })) !== null && _groupQueueList$group !== void 0 ? _groupQueueList$group : [],\n                groupDiscountConfig: res2 === null || res2 === void 0 ? void 0 : (_res2$getDataConfig = res2.getDataConfig) === null || _res2$getDataConfig === void 0 ? void 0 : _res2$getDataConfig.value\n              }));\n\n            case 10:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee);\n    }));\n\n    function getData(_x, _x2) {\n      return _getData.apply(this, arguments);\n    }\n\n    return getData;\n  }(),\n  updateSelectNum: function updateSelectNum(value, option) {\n    var _reverse$find$id, _reverse, _reverse$find, _option$data$groupQue, _option$data$groupQue2, _dealDiscount, _groupDiscountConfig, _groupDiscountConfig$, _option$data$product$2;\n\n    var groupDiscountConfig = option.data.groupDiscountConfig;\n    var selectNum = value === option.data.selectNum ? 0 : value;\n    var selectQueueId = value === option.data.selectNum ? '' : (_reverse$find$id = (_reverse = _toConsumableArray(option.data.groupQueueList).reverse()) === null || _reverse === void 0 ? void 0 : (_reverse$find = _reverse.find(function (v) {\n      var _v$sumFillAmount, _option$data$product$, _option$data, _option$data$product;\n\n      return ((_v$sumFillAmount = v.sumFillAmount) !== null && _v$sumFillAmount !== void 0 ? _v$sumFillAmount : 0) + value <= ((_option$data$product$ = (_option$data = option.data) === null || _option$data === void 0 ? void 0 : (_option$data$product = _option$data.product) === null || _option$data$product === void 0 ? void 0 : _option$data$product.groupPrecision) !== null && _option$data$product$ !== void 0 ? _option$data$product$ : 0);\n    })) === null || _reverse$find === void 0 ? void 0 : _reverse$find.id) !== null && _reverse$find$id !== void 0 ? _reverse$find$id : '';\n    option.setData(fpMergePre({\n      selectNum: selectNum,\n      selectQueueId: selectQueueId,\n      groupDiscount: ((_option$data$groupQue = (_option$data$groupQue2 = option.data.groupQueueList.find(function (value1) {\n        return value1.id === selectQueueId;\n      })) === null || _option$data$groupQue2 === void 0 ? void 0 : _option$data$groupQue2.sumFillAmount) !== null && _option$data$groupQue !== void 0 ? _option$data$groupQue : 0) + selectNum === option.data.product.groupPrecision ? dealDiscount(groupDiscountConfig.groupDiscount) : 1,\n      numDiscount: (_dealDiscount = dealDiscount(groupDiscountConfig === null || groupDiscountConfig === void 0 ? void 0 : (_groupDiscountConfig = groupDiscountConfig[(_option$data$product$2 = option.data.product.groupPrecision) !== null && _option$data$product$2 !== void 0 ? _option$data$product$2 : 0]) === null || _groupDiscountConfig === void 0 ? void 0 : (_groupDiscountConfig$ = _groupDiscountConfig.discount) === null || _groupDiscountConfig$ === void 0 ? void 0 : _groupDiscountConfig$[selectNum])) !== null && _dealDiscount !== void 0 ? _dealDiscount : 1\n    }));\n  },\n  clearData: function clearData(value, option) {\n    option.setData(fpMergePre({\n      selectNum: 0,\n      selectQueueId: '',\n      numDiscount: 1,\n      groupDiscount: 1\n    }));\n  },\n  submit: function () {\n    var _submit = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(_ref2, option) {\n      var orderInfoItemInput;\n      return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              orderInfoItemInput = _ref2.orderInfoItemInput;\n              _context2.next = 3;\n              return option.mutate(doc.saveGroupOrder, {\n                orderInfoItemInput: _objectSpread({}, orderInfoItemInput),\n                groupOrderItemInput: {\n                  orderGroupAmount: option.data.selectNum\n                },\n                groupQueueItemInput: _objectSpread({\n                  product: option.data.product\n                }, option.data.selectQueueId ? {\n                  id: option.data.selectQueueId\n                } : {})\n              });\n\n            case 3:\n              return _context2.abrupt(\"return\", _context2.sent);\n\n            case 4:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, _callee2);\n    }));\n\n    function submit(_x3, _x4) {\n      return _submit.apply(this, arguments);\n    }\n\n    return submit;\n  }()\n});\nvar PriceRed = styled.div.withConfig({\n  displayName: \"id__PriceRed\",\n  componentId: \"ghx5mg-0\"\n})([\"background:\", \";color:white;display:grid;grid-template-columns:1fr 120px;grid-template-rows:repeat(2,30px);align-items:center;> main{grid-area:1/1/3/2;padding-left:20px;> span{margin-left:16px;}}\"], mpStyle.red);\nvar Name = styled.div.withConfig({\n  displayName: \"id__Name\",\n  componentId: \"ghx5mg-1\"\n})([\"padding:16px 20px;display:flex;align-items:flex-end;> main{font-size:22px;margin-right:8px;flex-shrink:0;}> section{> span{padding:0 4px;background:\", \";border-radius:4px;position:relative;bottom:-4px;margin-left:8px;display:inline-flex;align-items:center;}}grid-auto-flow:column;\"], grey['700']);\nexport var YellowStar = function YellowStar() {\n  return __jsx(StarRoundedIcon, {\n    fontSize: 'small',\n    style: {\n      color: '#FDD334'\n    }\n  });\n};\nvar Title = styled.header.withConfig({\n  displayName: \"id__Title\",\n  componentId: \"ghx5mg-2\"\n})([\"font-size:20px;\"]);\nvar GroupQueueBox = styled.div.withConfig({\n  displayName: \"id__GroupQueueBox\",\n  componentId: \"ghx5mg-3\"\n})([\"padding:16px;\"]);\nvar SmartMatch = styled.div.withConfig({\n  displayName: \"id__SmartMatch\",\n  componentId: \"ghx5mg-4\"\n})([\"padding:16px 16px 90px;> section{margin-top:8px;display:flex;align-items:center;}> main{> svg{font-size:3.0rem;}}\"]);\nvar Submit = styled.div.withConfig({\n  displayName: \"id__Submit\",\n  componentId: \"ghx5mg-5\"\n})([\"background:white;border-top:1px solid \", \";display:flex;align-items:center;justify-content:space-between;> aside{padding-left:16px;color:\", \";}\"], mpStyle.red, mpStyle.red);\nexport var GroupSubmit = function GroupSubmit(_ref3) {\n  var className = _ref3.className,\n      submitCall = _ref3.submitCall;\n\n  var _useStoreModel = useStoreModel(ShopCartModel),\n      actionsShopCartModel = _useStoreModel.actions;\n\n  var _useStoreModel2 = useStoreModel(groupProductModel),\n      stateGroupProduct = _useStoreModel2.state;\n\n  return __jsx(Submit, {\n    className: className\n  }, __jsx(\"aside\", null, ll('选择了'), stateGroupProduct.selectNum, ll('份')), __jsx(Button, {\n    disabled: stateGroupProduct.selectNum === 0,\n    style: {\n      height: '100%',\n      padding: '0 32px',\n      borderRadius: '0',\n      fontSize: '18px'\n    },\n    color: 'secondary',\n    variant: 'contained',\n    onClick: function onClick() {\n      actionsShopCartModel.updateIsGroupOrder(true);\n      submitCall && submitCall();\n    }\n  }, ll('去结算')));\n};\nvar GroupSubmitBox = styled(GroupSubmit).withConfig({\n  displayName: \"id__GroupSubmitBox\",\n  componentId: \"ghx5mg-6\"\n})([\"&&&{position:fixed;height:60px;bottom:0;width:100vw;box-shadow:\", \";}\"], mpStyle.shadow['1']);\nexport var GroupProduct = function GroupProduct() {\n  var _ref4, _router$query, _product$img;\n\n  var router = useRouter();\n  var id = (_ref4 = (_router$query = router.query) === null || _router$query === void 0 ? void 0 : _router$query.id) !== null && _ref4 !== void 0 ? _ref4 : '';\n\n  var _useStoreModel3 = useStoreModel(groupOrderPageModel),\n      actionsGroupOrderPageModel = _useStoreModel3.actions;\n\n  var _useStoreModel4 = useStoreModel(groupProductModel),\n      actionsGroupProduct = _useStoreModel4.actions,\n      stateGroupProduct = _useStoreModel4.state;\n\n  useEffect(function () {\n    actionsGroupProduct.getData(id);\n  }, [actionsGroupProduct, id]);\n  var product = stateGroupProduct.product; // useEffect(() => {\n  //   actionsGroupProduct.updateSelectNum(2)\n  //   actionsGroupOrderPageModel.open()\n  // }, [])\n\n  return __jsx(\"div\", null, __jsx(HeaderTitle, {\n    title: '产品详情'\n  }), __jsx(CusCarousel, {\n    height: '240px',\n    dataList: product === null || product === void 0 ? void 0 : (_product$img = product.img) === null || _product$img === void 0 ? void 0 : _product$img.map(function (v) {\n      return _objectSpread(_objectSpread({}, v), {}, {\n        imgUrl: v === null || v === void 0 ? void 0 : v.url\n      });\n    })\n  }), __jsx(PriceRed, null, __jsx(\"main\", null, ll('基准价格'), __jsx(\"span\", null, dealMoney(product.priceOut), \"/\", product.groupAmountUnitString)), __jsx(\"aside\", null, ll('已成团'), stateGroupProduct.groupQueueList.filter(function (v) {\n    return v.sumFillAmount === (product === null || product === void 0 ? void 0 : product.groupPrecision);\n  }).length, ll('单')), __jsx(\"aside\", null, ll('拼团中'), stateGroupProduct.groupQueueList.filter(function (v) {\n    var _v$sumFillAmount2, _product$groupPrecisi2;\n\n    return ((_v$sumFillAmount2 = v.sumFillAmount) !== null && _v$sumFillAmount2 !== void 0 ? _v$sumFillAmount2 : 0) < ((_product$groupPrecisi2 = product === null || product === void 0 ? void 0 : product.groupPrecision) !== null && _product$groupPrecisi2 !== void 0 ? _product$groupPrecisi2 : 0);\n  }).length, ll('单'))), __jsx(Name, null, __jsx(\"main\", null, product.name), __jsx(\"section\", null, product.groupRemark, \"/\", product.groupAmount, product.groupAmountUnitString, \" \", \"\\u6BCF\\u4E00\\u4EFD\".concat(dealGroupNumbers(product)).concat(product.groupAmountUnitString), __jsx(\"br\", null), ll('分团精度'), __jsx(\"span\", null, _toConsumableArray(Array(product.groupPrecision)).map(function (v, i) {\n    return i;\n  }).map(function (value) {\n    return __jsx(YellowStar, {\n      key: value\n    });\n  })))), __jsx(GroupQueueBox, null, __jsx(Title, null, ll('拼团中')), __jsx(GroupQueueList, null)), __jsx(SmartMatch, null, __jsx(\"header\", null, __jsx(Title, null, ll('智能匹配'))), __jsx(\"section\", null, ll('请点击'), __jsx(StarBorderRoundedIcon, null), ll('确定您需要的份数')), __jsx(\"main\", null, _toConsumableArray(Array(product.groupPrecision)).map(function (v, i) {\n    return i;\n  }).map(function (value) {\n    return value + 1 > stateGroupProduct.selectNum ? __jsx(StarBorderRoundedIcon, {\n      key: \"clickStar\".concat(value),\n      fontSize: 'large',\n      onClick: function onClick() {\n        return actionsGroupProduct.updateSelectNum(value + 1);\n      }\n    }) : __jsx(StarRoundedIcon, {\n      key: \"clickStar\".concat(value),\n      style: {\n        color: '#FDD334'\n      },\n      fontSize: 'large',\n      onClick: function onClick() {\n        return actionsGroupProduct.updateSelectNum(value + 1);\n      }\n    });\n  })), __jsx(PriceBox, null)), __jsx(GroupSubmitBox, {\n    submitCall: function submitCall() {\n      actionsGroupOrderPageModel.open();\n    }\n  }), __jsx(GroupOrderPage, null));\n};","map":null,"metadata":{},"sourceType":"module"}